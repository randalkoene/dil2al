<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>controller.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>controller.cc</h1><a href="controller_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// controller.cc</font>
00002 <font class="comment">// Randal A. Koene, 20000304</font>
00003 
00004 <font class="preprocessor">#include "<a class="code" href="dil2al_8hh.html">dil2al.hh</a>"</font>
00005 
<a name="l00006"></a><a class="code" href="controller_8cc.html#a0">00006</a> <a class="code" href="classString.html">String</a> <a class="code" href="controller_8cc.html#a0">chunk_controller</a>(<a class="code" href="classString.html">String</a> controllercmd) {
00007 <font class="comment">// Called timechunk minutes after starting a task chunk</font>
00008 <font class="comment">// (e.g. via at-jobs or a timer daemon, which could be</font>
00009 <font class="comment">// constructed as an AfterStep Wharf applet).</font>
00010 <font class="comment">// It can also be called before timechunk minutes have</font>
00011 <font class="comment">// passed if the chunk is stopped early.</font>
00012 <font class="comment">// As previous chunks are closed with stop_TL_chunk() where</font>
00013 <font class="comment">// necessary with options C,S or T, AL updating options</font>
00014 <font class="comment">// determine if and how the current AL and closed chunk's DIL</font>
00015 <font class="comment">// entry should be updated, and the corresponding update is done.</font>
00016         <font class="keyword">const</font> <font class="keywordtype">int</font> LLEN = 10240;
00017         <font class="keywordtype">char</font> lbuf[LLEN];
00018         <font class="comment">// check if audio-visual flag is to be made noticable</font>
00019         <font class="keywordflow">if</font> (showflag) {
00020                 cout &lt;&lt; <font class="stringliteral">"\a"</font>;
00021                 <font class="keywordflow">if</font> (flagcmd!=<font class="stringliteral">""</font>) {
00022                         <font class="keywordflow">if</font> (system(flagcmd)&lt;0) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unable to show visual flag in chunk_controller(), continuing\n"</font>;
00023                 }
00024         }
00025         <font class="comment">// show next AL item(s) (may involve recomputing)</font>
00026 <font class="comment">//*** recomputation of AL not yet included</font>
00027 <font class="preprocessor">#ifdef DEBUG</font>
00028 <font class="preprocessor"></font>        cout &lt;&lt; <font class="stringliteral">"dil2al: DEBUG - Recomputation of ALs in chunk_controller() not yet implemented\n"</font>;
00029 <font class="preprocessor">#endif</font>
00030 <font class="preprocessor"></font>        <font class="comment">// offer opportunity to make a Task Log entry</font>
00031         <font class="keywordtype">bool</font> madenote = <font class="keyword">false</font>;
00032         chunkcreated = <font class="keyword">false</font>; <font class="comment">// reset process variable</font>
00033         <font class="keywordflow">if</font> (useansi) cout &lt;&lt; <a class="code" href="dil2al_8hh.html#a91">ANSI_BOLD_ON</a>; <font class="comment">// bold on</font>
00034         <a class="code" href="utilities_8cc.html#a29">auto_interactive</a>(controllercmd,<font class="stringliteral">"Make Note/Task Log entry? (y/N) "</font>,lbuf,LLEN);
00035         <font class="keywordflow">if</font> (useansi) cout &lt;&lt; <a class="code" href="dil2al_8hh.html#a92">ANSI_BOLD_OFF</a>; <font class="comment">// bold off</font>
00036         <font class="keywordflow">if</font> ((lbuf[0]==<font class="charliteral">'y'</font>) || (lbuf[0]==<font class="charliteral">'Y'</font>)) {
00037                 <font class="comment">// make Task Log entry</font>
00038                 <font class="keywordflow">if</font> (!<a class="code" href="note_8cc.html#a338">make_note</a>()) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unable to make note in chunk_contorller(), continuing as is\n"</font>;
00039                 madenote = <font class="keyword">true</font>;
00040         }
00041         <font class="comment">// offer controller options</font>
00042         lbuf[0]=<font class="charliteral">'\0'</font>; <a class="code" href="classString.html">String</a> chunkid;
00043         <font class="keywordflow">while</font> (lbuf[0]==<font class="charliteral">'\0'</font>) {
00044                 <a class="code" href="classString.html">String</a> message = <font class="stringliteral">"\nOptions:\n[C]ontinue Task Chunk if Time Remaining else Start New Task Chunk\n"</font>;
00045                 <font class="keywordflow">if</font> (!chunkcreated) message += <font class="stringliteral">"[S]tart New Task Chunk (new task context)\n"</font>;
00046                 message += <font class="stringliteral">"S[t]op Task Chunk (pause list tasks)\nE[x]it Retaining Current State (ignore list suggestions)\n"</font>;
00047                 <font class="keywordflow">if</font> (useansi) cout &lt;&lt; <a class="code" href="dil2al_8hh.html#a91">ANSI_BOLD_ON</a>; <font class="comment">// bold on</font>
00048                 <a class="code" href="utilities_8cc.html#a29">auto_interactive</a>(controllercmd,message,lbuf,LLEN);
00049                 <font class="keywordflow">if</font> (useansi) cout &lt;&lt; <a class="code" href="dil2al_8hh.html#a92">ANSI_BOLD_OFF</a>; <font class="comment">// bold off</font>
00050                 <font class="comment">// refresh curtime to avoid misrepresentations due to long delay before option selection</font>
00051                 <font class="comment">// but don't change time if madenote to properly detect chunkid==curtime</font>
00052                 <font class="comment">// if a new chunk was made during make_note()</font>
00053                 <font class="keywordflow">if</font> (!madenote) curtime = <a class="code" href="utilities_8cc.html#a20">time_stamp</a>(<font class="stringliteral">"%Y%m%d%H%M"</font>);
00054                 <a class="code" href="classString.html">String</a> tl; <font class="keywordtype">int</font> tlinsertloc;
00055                 <font class="keywordflow">switch</font> (lbuf[0]) {
00056                         <font class="keywordflow">case</font> <font class="charliteral">'c'</font>: <font class="keywordflow">case</font> <font class="charliteral">'C'</font>:
00057                                 <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Continuing according to task list chunk controller suggestions\n"</font>;
00058                                 tlinsertloc = -1;
00059                                 <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="tladmin_8cc.html#a316">get_TL_head</a>(),tl)) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00060                                 <font class="keywordflow">if</font> (tl==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> tl;
00061                                 <font class="keywordflow">if</font> ((chunkid=<a class="code" href="tladmin_8cc.html#a12">decide_add_TL_chunk</a>(tl,tlinsertloc,<font class="keyword">true</font>,<font class="keyword">false</font>))==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00062                                 <font class="keywordflow">break</font>;
00063                         <font class="keywordflow">case</font> <font class="charliteral">'s'</font>: <font class="keywordflow">case</font> <font class="charliteral">'S'</font>:
00064                                 <font class="keywordflow">if</font> (!chunkcreated) {
00065                                         <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Starting task chunk with new context\n"</font>;
00066                                         tlinsertloc = -1;
00067                                         <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="tladmin_8cc.html#a316">get_TL_head</a>(),tl)) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00068                                         <font class="keywordflow">if</font> (tl==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> tl;
00069                                         <font class="keywordflow">if</font> ((chunkid=<a class="code" href="tladmin_8cc.html#a12">decide_add_TL_chunk</a>(tl,tlinsertloc,<font class="keyword">false</font>,<font class="keyword">false</font>))==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00070                                 } <font class="keywordflow">else</font> {
00071                                         <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unknown option `"</font> &lt;&lt; lbuf[0] &lt;&lt; <font class="stringliteral">"'\n"</font>;
00072                                         lbuf[0]=<font class="charliteral">'\0'</font>;
00073                                 }
00074                                 <font class="keywordflow">break</font>;
00075                         <font class="keywordflow">case</font> <font class="charliteral">'t'</font>: <font class="keywordflow">case</font> <font class="charliteral">'T'</font>:
00076 <font class="comment">//*** instead of this approach, which exits once list tasks are paused</font>
00077 <font class="comment">//*** it is possible to stay in this while loop and offer exit as well</font>
00078 <font class="comment">//*** as start with comparetimes=false in the decide_add_TL_chunk() call</font>
00079                                 <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Stopping task chunk and pausing list tasks\n"</font>;
00080                                 <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="tladmin_8cc.html#a316">get_TL_head</a>(),tl)) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00081                                 <font class="keywordflow">if</font> (tl==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> tl;
00082                                 <a class="code" href="tladmin_8cc.html#a6">stop_TL_chunk</a>(tl);
00083                                 <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a41">write_file_from_String</a>(taskloghead,tl,<font class="stringliteral">"Task Log"</font>)) <font class="keywordflow">return</font> <a class="code" href="classString.html">String</a>(<font class="stringliteral">""</font>);
00084                                 chunkid = <font class="stringliteral">"-1"</font>;
00085                                 <font class="keywordflow">break</font>;
00086                         <font class="keywordflow">case</font> <font class="charliteral">'x'</font>: <font class="keywordflow">case</font> <font class="charliteral">'X'</font>:
00087                                 <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Exiting and retaining current task state\n"</font>;
00088                                 chunkid = <font class="stringliteral">"-2"</font>;
00089                                 <font class="keywordflow">break</font>;
00090                         <font class="keywordflow">default</font>:
00091                                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unknown option `"</font> &lt;&lt; lbuf[0] &lt;&lt; <font class="stringliteral">"'\n"</font>;
00092                                 lbuf[0] = <font class="charliteral">'\0'</font>;
00093                 }
00094         }
00095         <font class="keywordflow">return</font> chunkid;
00096 }
00097 
<a name="l00098"></a><a class="code" href="controller_8cc.html#a1">00098</a> <font class="keyword">inline</font> time_t <a class="code" href="controller_8cc.html#a1">time_chunk_remaining</a>(<a class="code" href="classString.html">String</a> chunkid) {
00099         time_t tdiff = timechunksize*60;
00100         tdiff -= <a class="code" href="utilities_8cc.html#a26">time_stamp_diff</a>(chunkid,<a class="code" href="utilities_8cc.html#a20">time_stamp</a>(<font class="stringliteral">"%Y%m%d%H%M"</font>));
00101         <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"\nTask schedule controller: "</font> &lt;&lt; tdiff &lt;&lt; <font class="stringliteral">" seconds remaining in time chunk\n(Current chunk initiated at "</font> &lt;&lt; chunkid &lt;&lt; <font class="stringliteral">")\n"</font>;
00102         <font class="keywordflow">return</font> tdiff;
00103 }
00104 
<a name="l00105"></a><a class="code" href="controller_8cc.html#a2">00105</a> <font class="keywordtype">bool</font> <a class="code" href="controller_8cc.html#a2">schedule_controller</a>(<a class="code" href="classString.html">String</a> controllercmd) {
00106 <font class="comment">// schedules periodical calls to chunk_controller(),</font>
00107 <font class="comment">// either via an at-job or by retaining dil2al as a daemon</font>
00108         <a class="code" href="classString.html">String</a> chunkid;
00109         <font class="keywordflow">if</font> (isdaemon) { <font class="comment">// daemon schedules chunk_controller()</font>
00110                 <a class="code" href="classString.html">String</a> ccmd;
00111                 <font class="keywordflow">while</font> (1) {
00112                         ccmd = controllercmd; <font class="comment">// fresh copy of automatic commands to controller</font>
00113                         <font class="keywordflow">if</font> ((chunkid=<a class="code" href="controller_8cc.html#a0">chunk_controller</a>(ccmd))==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00114                         <font class="keywordflow">if</font> ((chunkid==<font class="stringliteral">"-1"</font>) || (chunkid==<font class="stringliteral">"-2"</font>)) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00115                         time_t tdiff = <a class="code" href="controller_8cc.html#a1">time_chunk_remaining</a>(chunkid);
00116                         <font class="keywordflow">if</font> (tdiff&gt;0) sleep(tdiff);
00117                 }
00118         } <font class="keywordflow">else</font> { <font class="comment">// at-job schedules chunk_controller()</font>
00119                 <font class="keywordflow">if</font> ((chunkid=<a class="code" href="controller_8cc.html#a0">chunk_controller</a>(controllercmd))==<font class="stringliteral">""</font>) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00120                 <font class="keywordflow">if</font> ((chunkid==<font class="stringliteral">"-1"</font>) || (chunkid==<font class="stringliteral">"-2"</font>)) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00121 <font class="preprocessor">#ifdef DEBUG</font>
00122 <font class="preprocessor"></font>cout &lt;&lt; <font class="stringliteral">"current chunkid = "</font> &lt;&lt; chunkid &lt;&lt; <font class="charliteral">'\n'</font>;
00123 <font class="preprocessor">#endif</font>
00124 <font class="preprocessor"></font>                time_t tdiff = <a class="code" href="controller_8cc.html#a1">time_chunk_remaining</a>(chunkid);
00125 <font class="preprocessor">#ifdef DEBUG</font>
00126 <font class="preprocessor"></font>cout &lt;&lt; <font class="stringliteral">"seconds remaining = "</font> &lt;&lt; tdiff &lt;&lt; <font class="charliteral">'\n'</font>;
00127 <font class="preprocessor">#endif</font>
00128 <font class="preprocessor"></font>                <font class="keywordflow">if</font> (tdiff&gt;0) {
00129                         tdiff /= 60;
00130                         <a class="code" href="classString.html">String</a> atcmd = atcommand;
00131                         <font class="keywordflow">if</font> (tdiff) { atcmd += <font class="stringliteral">" + "</font>; atcmd += dec(tdiff); atcmd += <font class="stringliteral">" minutes"</font>; }
00132                         <font class="keywordflow">else</font> atcmd += <font class="stringliteral">" + 1 minute"</font>;
00133                         FILE * p = popen((<font class="keyword">const</font> <font class="keywordtype">char</font> *) atcmd, <font class="stringliteral">"w"</font>);
00134                         <font class="keywordflow">if</font> (!p) {
00135                                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unable to schedule controller call with "</font> &lt;&lt; atcontroller &lt;&lt; <font class="stringliteral">" in schedule_controller()\n"</font>;
00136                                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00137                         }
00138                         fprintf(p,(<font class="keyword">const</font> <font class="keywordtype">char</font> *) atcontroller);
00139                         <font class="keywordflow">if</font> (pclose(p)==-1) {
00140                                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Scheduling controller call with "</font> &lt;&lt; atcontroller &lt;&lt; <font class="stringliteral">" did not complete operations in schedule_controller()\n"</font>;
00141                                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00142                         }
00143                 }
00144         }
00145 <font class="preprocessor">#ifdef DEBUG</font>
00146 <font class="preprocessor"></font><font class="keyword">const</font> <font class="keywordtype">int</font> LLEN = 10;
00147 <font class="keywordtype">char</font> lbuf[LLEN];
00148 cout &lt;&lt; <font class="stringliteral">"Scheduled controller processing completed...\n"</font>;
00149 cin.getline(lbuf,LLEN);
00150 <font class="preprocessor">#endif</font>
00151 <font class="preprocessor"></font>        <font class="keywordflow">return</font> <font class="keyword">true</font>;
00152 }
</pre></div><hr><address align="right"><small>Generated on Mon Sep 13 14:53:09 2004 for dil2al by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
