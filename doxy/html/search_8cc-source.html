<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>search.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>search.cc</h1><a href="search_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// search.cc</font>
00002 <font class="comment">// Randal A. Koene, 20011126</font>
00003 
00004 <font class="preprocessor">#include "<a class="code" href="dil2al_8hh.html">dil2al.hh</a>"</font>
00005 
00006 <font class="comment">/*</font>
00007 <font class="comment">        This may search by following links starting from a specific file,</font>
00008 <font class="comment">        directory or search engine search term, or may search a set of archive</font>
00009 <font class="comment">        locations.</font>
00010 <font class="comment">        Locations that point to directories or that are search engine search</font>
00011 <font class="comment">        terms must be turned into a list of specific targets to search. Note</font>
00012 <font class="comment">        that targets obtained in followlinks mode by Search_Target objects may</font>
00013 <font class="comment">        also point to such locations. In the case of breadth-first search the</font>
00014 <font class="comment">        conversion to specific targets may be done by the same function that</font>
00015 <font class="comment">        controls the searching process. Otherwise, the conversion must take</font>
00016 <font class="comment">        place in Search_Target, while adding targets to the list.</font>
00017 <font class="comment"></font>
00018 <font class="comment">        See &lt;A HREF="dil2al.hh"&gt;dil2al.hh&lt;/A&gt;.</font>
00019 <font class="comment">*/</font>
00020 
<a name="l00021"></a><a class="code" href="classTarget__Access.html#b0">00021</a> <font class="keywordtype">void</font> <a class="code" href="classTarget__Access.html#b0">Target_Access::set_target</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> * t, <font class="keyword">const</font> <a class="code" href="classTarget__Access.html">Target_Access</a> * parent = NULL) {
00022         <font class="comment">// Identify type of target and verify proper specification</font>
00023                                 <font class="comment">// *** generate new target, target is local if relative and current is local, followlinks-1</font>
00024                                 <font class="comment">// - put absolute file references in as such + server&amp;user if current is remote</font>
00025                                 <font class="comment">// - append relative file references to current target</font>
00026         <font class="comment">// Note: This function is currently not intended to be used to reinitialize Target_Access objects,</font>
00027         <font class="comment">// as it does not reset server and user parameters if the new target is local</font>
00028         <a class="code" href="classTarget__Access.html#n0">target</a> = t;
00029         <a class="code" href="classString.html">String</a> preslash(<a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a58">before</a>(<font class="charliteral">'/'</font>));
00030         preslash.<a class="code" href="classString.html#a82">upcase</a>();
00031         <font class="keywordflow">if</font> ((preslash == <font class="stringliteral">"HTTP:"</font>) || (preslash == <font class="stringliteral">"FTP:"</font>)) { <font class="comment">// Server and path references for URLs</font>
00032                 <font class="keywordflow">if</font> (preslash == <font class="stringliteral">"HTTP:"</font>) <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>;
00033                 <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s3">TA_FTP</a>;
00034                 <a class="code" href="classTarget__Access.html#b1">remove_name_reference</a>(<a class="code" href="classTarget__Access.html#n0">target</a>);
00035                 <font class="keywordtype">int</font> serverstart = <a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a26">index</a>(<font class="stringliteral">"://"</font>,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,0);
00036                 <font class="keywordflow">if</font> (serverstart&lt;0) {
00037                         <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Warning - malformed URL, "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n0">target</a> &lt;&lt; <font class="stringliteral">", in Target_Access::Target_Access()\n"</font>;
00038                         <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s4">TA_UNKNOWN</a>;
00039                         <font class="keywordflow">return</font>;
00040                 }
00041                 <font class="keywordtype">int</font> serverend = <a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a26">index</a>(<font class="charliteral">'/'</font>,serverstart);
00042                 <font class="keywordflow">if</font> (serverend&lt;0) serverend = <a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a105">length</a>();
00043                 <font class="keywordflow">if</font> (serverstart==serverend) {
00044                         <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Warning - malformed URL server, "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n0">target</a> &lt;&lt; <font class="stringliteral">", in Target_Access::Target_Access()\n"</font>;
00045                         <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s4">TA_UNKNOWN</a>;
00046                         <font class="keywordflow">return</font>;
00047                 }
00048                 <a class="code" href="classTarget__Access.html#n2">server</a> = <a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a51">at</a>(serverstart,serverend-serverstart);
00049                 <a class="code" href="classTarget__Access.html#n3">path</a> = <a class="code" href="classTarget__Access.html#n0">target</a>.<a class="code" href="classString.html#a70">from</a>(serverend);
00050                 <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a> == <a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>) <font class="keywordflow">return</font>;
00051                 <font class="comment">// FTP specific initialization</font>
00052                 <a class="code" href="classTarget__Access.html#n1">user</a> = <a class="code" href="classTarget__Access.html#n2">server</a>.<a class="code" href="classString.html#a58">before</a>(<font class="charliteral">'@'</font>);
00053                 <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n1">user</a>.<a class="code" href="classString.html#a106">empty</a>()) <a class="code" href="classTarget__Access.html#n2">server</a> = <a class="code" href="classTarget__Access.html#n2">server</a>.<a class="code" href="classString.html#a76">after</a>(<font class="charliteral">'@'</font>);
00054                 <font class="keywordflow">return</font>;
00055         }
00056         <font class="comment">// Local file specific initialization</font>
00057         <a class="code" href="classTarget__Access.html#n3">path</a> = <a class="code" href="classTarget__Access.html#n0">target</a>;
00058         <font class="keywordflow">if</font> (parent) { <font class="comment">// reference relative to parent</font>
00059                 <font class="keywordflow">if</font> ((parent-&gt;type==<a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>) || (parent-&gt;type==<a class="code" href="classTarget__Access.html#s5s3">TA_FTP</a>)) { <font class="comment">// relative to remote</font>
00060                         <a class="code" href="classTarget__Access.html#n4">type</a> = parent-&gt;type;
00061                         <a class="code" href="classTarget__Access.html#n2">server</a> = parent-&gt;server;
00062                         <a class="code" href="classTarget__Access.html#n1">user</a> = parent-&gt;user;
00063                         <font class="comment">// *** problem: if parent target was an ftp or http directory without a '/' at</font>
00064                         <font class="comment">//     the end, then there is no way to know if the last part of the target path</font>
00065                         <font class="comment">//     is part of the path to prepend or not</font>
00066                         <font class="comment">//     You actually *have* this information, because if you are setting up a</font>
00067                         <font class="comment">//     target relative to a parent, then you have that parent's contents, from</font>
00068                         <font class="comment">//     which you got the link... so you can see if it's a directory index</font>
00069                         <font class="comment">// *** problem: at some point between reading the citeseer site and the nec.com</font>
00070                         <font class="comment">//     site, dil2al appears to develop a memory leak and grows rapidly then crashes</font>
00071                         <font class="comment">// *** problem: there has to be another way around the long wget wait for</font>
00072                         <font class="comment">//     connections, perhaps a site's availability can be tested some other way</font>
00073                         <font class="comment">//     before attempting a wget</font>
00074                         <a class="code" href="classTarget__Access.html#b1">remove_name_reference</a>(<a class="code" href="classTarget__Access.html#n3">path</a>);
00075                         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a101">firstchar</a>()!=<font class="charliteral">'/'</font>) <a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a22">prepend</a>(const_cast&lt;String &amp;&gt;(parent-&gt;path).through(<font class="charliteral">'/'</font>,-1));
00076                         <a class="code" href="classTarget__Access.html#b2">remove_back_references</a>(<a class="code" href="classTarget__Access.html#n3">path</a>);
00077                         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a>==<a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>) <a class="code" href="classTarget__Access.html#n0">target</a> = <font class="stringliteral">"http://"</font>+<a class="code" href="classTarget__Access.html#n2">server</a>+<a class="code" href="classTarget__Access.html#n3">path</a>;
00078                         <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n0">target</a> = <font class="stringliteral">"ftp://"</font>+<a class="code" href="classTarget__Access.html#n1">user</a>+<font class="charliteral">'@'</font>+<a class="code" href="classTarget__Access.html#n2">server</a>+<a class="code" href="classTarget__Access.html#n3">path</a>;
00079                         <font class="keywordflow">return</font>;
00080                 } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a101">firstchar</a>()!=<font class="charliteral">'/'</font>) { <font class="comment">// relative to local</font>
00081                         <font class="keywordflow">if</font> (parent-&gt;type==<a class="code" href="classTarget__Access.html#s5s1">TA_LOCAL_DIRECTORY</a>) {
00082                                 <font class="keywordflow">if</font> (parent-&gt;path.lastchar()!=<font class="charliteral">'/'</font>) <a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a22">prepend</a>(<font class="charliteral">'/'</font>);
00083                                 <a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a22">prepend</a>(parent-&gt;path);
00084                         } <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n3">path</a>.<a class="code" href="classString.html#a22">prepend</a>(const_cast&lt;String &amp;&gt;(parent-&gt;path).through(<font class="charliteral">'/'</font>,-1));
00085                 }
00086         }
00087         <font class="comment">// local reference</font>
00088         <a class="code" href="classTarget__Access.html#b2">remove_back_references</a>(<a class="code" href="classTarget__Access.html#n3">path</a>);
00089         <a class="code" href="classTarget__Access.html#n0">target</a> = <a class="code" href="classTarget__Access.html#n3">path</a>; <font class="comment">// complete local target reference</font>
00090         <font class="keywordflow">if</font> (<a class="code" href="utilities_8cc.html#a34">file_is_directory</a>(<a class="code" href="classTarget__Access.html#n3">path</a>)) <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s1">TA_LOCAL_DIRECTORY</a>;
00091         <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n4">type</a> = <a class="code" href="classTarget__Access.html#s5s0">TA_LOCAL</a>;
00092 }
00093 
<a name="l00094"></a><a class="code" href="search_8cc.html#a0">00094</a> <font class="keywordtype">void</font> <a class="code" href="search_8cc.html#a0">generic_remove_name_reference</a>(<a class="code" href="classString.html">String</a> &amp; tpath) {
00095         <font class="keywordtype">int</font> nameref = tpath.<a class="code" href="classString.html#a26">index</a>(<font class="charliteral">'#'</font>,-1);
00096         <font class="keywordtype">int</font> fileref = tpath.<a class="code" href="classString.html#a26">index</a>(<font class="charliteral">'/'</font>,-1);
00097         <font class="keywordflow">if</font> ((nameref&gt;=0) &amp;&amp; (nameref&gt;fileref)) tpath.<a class="code" href="classString.html#a83">del</a>(nameref,tpath.<a class="code" href="classString.html#a105">length</a>()-nameref);
00098 }
00099 
<a name="l00100"></a><a class="code" href="classTarget__Access.html#b1">00100</a> <font class="keywordtype">void</font> <a class="code" href="classTarget__Access.html#b1">Target_Access::remove_name_reference</a>(<a class="code" href="classString.html">String</a> &amp; tpath) {
00101         <font class="comment">// Removes a potential #name reference from an http target or path</font>
00102         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a> == <a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>) <a class="code" href="search_8cc.html#a0">generic_remove_name_reference</a>(tpath);
00103 }
00104 
<a name="l00105"></a><a class="code" href="classTarget__Access.html#b2">00105</a> <font class="keywordtype">void</font> <a class="code" href="classTarget__Access.html#b2">Target_Access::remove_back_references</a>(<a class="code" href="classString.html">String</a> &amp; tpath) {
00106         <font class="comment">// Removes ./ and ../ references from a path</font>
00107         tpath.<a class="code" href="classString.html#a89">gsub</a>(<font class="stringliteral">"/./"</font>,<font class="stringliteral">"/"</font>);
00108         <font class="keywordflow">if</font> ((tpath.<a class="code" href="classString.html#a101">firstchar</a>()==<font class="charliteral">'.'</font>) &amp;&amp; (tpath[1]==<font class="charliteral">'/'</font>)) tpath.<a class="code" href="classString.html#a83">del</a>(0,2);
00109         <font class="keywordtype">int</font> i, j;
00110         <font class="keywordflow">while</font> ((i=tpath.<a class="code" href="classString.html#a26">index</a>(<font class="stringliteral">"/../"</font>))&gt;=0) {
00111                 <font class="keywordflow">if</font> ((j=tpath.<a class="code" href="classString.html#a26">index</a>(<font class="charliteral">'/'</font>,(i-tpath.<a class="code" href="classString.html#a105">length</a>())-1))&lt;0) j=-1;
00112                 j++;
00113                 tpath.<a class="code" href="classString.html#a83">del</a>(j,(i-j)+4);
00114         }
00115 }
00116 
00117 <font class="preprocessor">#ifdef TARGET_ACCESS_DEBUG</font>
00118 <font class="preprocessor"></font><font class="keywordtype">void</font> Target_Access::Report()<font class="keyword"> const </font>{
00119         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::target = "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n0">target</a> &lt;&lt; <font class="charliteral">'\n'</font>;
00120         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::user = "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n1">user</a> &lt;&lt; <font class="charliteral">'\n'</font>;
00121         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::server = "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n2">server</a> &lt;&lt; <font class="charliteral">'\n'</font>;
00122         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::path = "</font> &lt;&lt; <a class="code" href="classTarget__Access.html#n3">path</a> &lt;&lt; <font class="charliteral">'\n'</font>;
00123         <font class="keywordflow">switch</font> (type) {
00124                 <font class="keywordflow">case</font> <a class="code" href="classTarget__Access.html#s5s0">TA_LOCAL</a>: <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::type = TA_LOCAL\n"</font>; <font class="keywordflow">break</font>;
00125                 <font class="keywordflow">case</font> <a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>: <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::type = TA_HTTP\n"</font>; <font class="keywordflow">break</font>;
00126                 <font class="keywordflow">case</font> <a class="code" href="classTarget__Access.html#s5s3">TA_FTP</a>: <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::type = TA_FTP\n"</font>; <font class="keywordflow">break</font>;
00127                 <font class="keywordflow">case</font> <a class="code" href="classTarget__Access.html#s5s4">TA_UNKNOWN</a>: <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"Target_Access::type = TA_UNKNOWN\n"</font>; <font class="keywordflow">break</font>;
00128         }
00129 }
00130 <font class="preprocessor">#endif</font>
00131 <font class="preprocessor"></font>
<a name="l00132"></a><a class="code" href="classTarget__Access.html#b3">00132</a> <font class="keywordtype">void</font> <a class="code" href="classTarget__Access.html#b3">Target_Access::transformed_name</a>(<a class="code" href="classString.html">String</a> &amp; transformed, <a class="code" href="classString.html">String</a> &amp; prevname) {
00133         <font class="keywordflow">if</font> (transformed.<a class="code" href="classString.html#a106">empty</a>()) transformed = prevname;
00134         <font class="keywordflow">if</font> ((prevname==<a class="code" href="classTarget__Access.html#n3">path</a>) || (prevname==<a class="code" href="classTarget__Access.html#n0">target</a>)) {
00135                 transformed.<a class="code" href="classString.html#a89">gsub</a>(<font class="charliteral">'/'</font>,<font class="charliteral">'%'</font>);
00136                 transformed.<a class="code" href="classString.html#a22">prepend</a>(tareadfile);
00137         }
00138 }
00139 
<a name="l00140"></a><a class="code" href="classTarget__Access.html#b4">00140</a> <font class="keywordtype">void</font> <a class="code" href="classTarget__Access.html#b3">Target_Access::transformed_name</a>(<a class="code" href="classString.html">String</a> &amp; transformed, <a class="code" href="classString.html">String</a> &amp; prevname, <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> &amp; transrx) {
00141         transformed = prevname.<a class="code" href="classString.html#a58">before</a>(transrx.<a class="code" href="classBigRegex.html#a5">subpos</a>());
00142         <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(transformed,prevname);
00143 }
00144 
<a name="l00145"></a><a class="code" href="classTarget__Access.html#b5">00145</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#b5">Target_Access::make_local_copy_of_directory</a>() {
00146         <font class="comment">// create HTML list of links for directory entries</font>
00147         <font class="comment">// Note: localcopy must point to a valid temporary file name</font>
00148         <font class="comment">// get directory</font>
00149         <a class="code" href="classStringList.html">StringList</a> dirtargets;
00150         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> num = <a class="code" href="search_8cc.html#a3">Get_Target_Directory</a>(dirtargets,0,<a class="code" href="classTarget__Access.html#n3">path</a>);
00151         <font class="comment">// create HTML links</font>
00152         <a class="code" href="classString.html">String</a> dirfile(<font class="stringliteral">"&lt;HTML&gt;\n&lt;HEAD&gt;\n&lt;TITLE&gt;Local Directory: "</font>+<a class="code" href="classTarget__Access.html#n3">path</a>+<font class="stringliteral">"&lt;/TITLE&gt;\n&lt;/HEAD&gt;\n&lt;BODY&gt;\n&lt;H1&gt;Local Directory: "</font>+<a class="code" href="classTarget__Access.html#n3">path</a>+<font class="stringliteral">"&lt;/H1&gt;\n\n"</font>);
00153         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i = 0; i&lt;num; i++) dirfile += <a class="code" href="utilities_8cc.html#a68">HTML_put_href</a>(dirtargets[i],dirtargets[i].after(<font class="charliteral">'/'</font>,-1)) + <font class="stringliteral">"\n&lt;P&gt;\n"</font>;
00154         dirfile += <font class="stringliteral">"(Temporary local HTML copy of directory created by dil2al "</font>+curtime+<font class="stringliteral">")\n\n&lt;/BODY&gt;\n&lt;/HTML&gt;\n"</font>;
00155         <font class="comment">// write local file</font>
00156         <a class="code" href="utilities_8cc.html#a41">write_file_from_String</a>(<a class="code" href="classTarget__Access.html#n5">localcopy</a>,dirfile,<font class="stringliteral">""</font>,<font class="keyword">true</font>); <font class="comment">// message used to be: "Local copy of "+path+" directory"</font>
00157         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00158 }
00159 
<a name="l00160"></a><a class="code" href="classTarget__Access.html#b6">00160</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#b6">Target_Access::make_local_copy_of_HTTP</a>(){
00161         <font class="comment">// Note: The wget utility has a smaller footprint than the lynx browser, but</font>
00162         <font class="comment">// has some difficulties with unresponsive connections, as it tends to wait</font>
00163         <font class="comment">// just as long for a connection as it does between network packages (specified</font>
00164         <font class="comment">// with the -T option, with a default of 15 minutes).</font>
00165         <font class="comment">// *** An alternative solution for this is to do searching or at least remote</font>
00166         <font class="comment">//     retrieval in the background with multiple threads, as indicated in the</font>
00167         <font class="comment">//     DIL entry &lt;A HREF="../../doc/html/lists/dil2al.html#20000930123422.1"&gt;DIL#20000930123422.1&lt;/A&gt;.</font>
00168         <font class="keywordflow">return</font> <a class="code" href="classTarget__Access.html#b8">syscommand</a>(<font class="stringliteral">"lynx"</font>,<font class="stringliteral">"-connect_timeout=30 -source "</font>+<a class="code" href="classTarget__Access.html#n0">target</a>+<font class="stringliteral">" &gt; "</font>+<a class="code" href="classTarget__Access.html#n5">localcopy</a>);
00169         <font class="comment">//return syscommand("wget","-q -t 2 -O "+localcopy+' '+target);</font>
00170 }
00171 
<a name="l00172"></a><a class="code" href="classTarget__Access.html#b7">00172</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#b7">Target_Access::make_local_copy_of_FTP</a>(){
00173         <font class="comment">// Note: The wget utility has a smaller footprint than the lynx browser, but</font>
00174         <font class="comment">// has some difficulties with unresponsive connections, as it tends to wait</font>
00175         <font class="comment">// just as long for a connection as it does between network packages (specified</font>
00176         <font class="comment">// with the -T option, with a default of 15 minutes).</font>
00177         <font class="keywordflow">return</font> <a class="code" href="classTarget__Access.html#b8">syscommand</a>(<font class="stringliteral">"lynx"</font>,<font class="stringliteral">"-connect_timeout=30 -source "</font>+<a class="code" href="classTarget__Access.html#n0">target</a>+<font class="stringliteral">" &gt; "</font>+<a class="code" href="classTarget__Access.html#n5">localcopy</a>);
00178         <font class="comment">//return syscommand("wget","-q -t 2 --retr-symlinks -O "+localcopy+' '+target);</font>
00179 }
00180 
<a name="l00181"></a><a class="code" href="classTarget__Access.html#a6">00181</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a6">Target_Access::make_local_copy</a>() {
00182         <font class="comment">// makes sure a local copy is available</font>
00183         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n5">localcopy</a>.<a class="code" href="classString.html#a106">empty</a>()) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00184         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a>==<a class="code" href="classTarget__Access.html#s5s4">TA_UNKNOWN</a>) {
00185                 <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unable to access unknown target type in Target_Access::make_local_copy()\n"</font>;
00186                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00187         }
00188         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a>==<a class="code" href="classTarget__Access.html#s5s0">TA_LOCAL</a>) <a class="code" href="classTarget__Access.html#n5">localcopy</a> = <a class="code" href="classTarget__Access.html#n3">path</a>;
00189         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a>==<a class="code" href="classTarget__Access.html#s5s1">TA_LOCAL_DIRECTORY</a>) {
00190                 <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(<a class="code" href="classTarget__Access.html#n5">localcopy</a>,<a class="code" href="classTarget__Access.html#n3">path</a>);
00191                 remove(<a class="code" href="classTarget__Access.html#n5">localcopy</a>); <font class="comment">// remove possible stale file</font>
00192                 <font class="keywordflow">return</font> <a class="code" href="classTarget__Access.html#b5">make_local_copy_of_directory</a>();
00193         } <font class="keywordflow">else</font> {
00194                 <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(<a class="code" href="classTarget__Access.html#n5">localcopy</a>,<a class="code" href="classTarget__Access.html#n0">target</a>);
00195                 remove(<a class="code" href="classTarget__Access.html#n5">localcopy</a>); <font class="comment">// remove possible stale file</font>
00196                 <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n4">type</a>==<a class="code" href="classTarget__Access.html#s5s2">TA_HTTP</a>) <font class="keywordflow">return</font> <a class="code" href="classTarget__Access.html#b6">make_local_copy_of_HTTP</a>();
00197                 <font class="keywordflow">else</font> <font class="keywordflow">return</font> <a class="code" href="classTarget__Access.html#b7">make_local_copy_of_FTP</a>();
00198         }
00199         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00200 }
00201 
<a name="l00202"></a><a class="code" href="classTarget__Access.html#b8">00202</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#b8">Target_Access::syscommand</a>(<a class="code" href="classString.html">String</a> program, <a class="code" href="classString.html">String</a> args, <font class="keywordtype">int</font> success = 0)<font class="keyword"> const </font>{
00203         <font class="keywordtype">int</font> sysret = system(program+<font class="charliteral">' '</font>+args);
00204         <font class="keywordflow">if</font> (sysret==success) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00205         <font class="keywordflow">switch</font> (sysret) {
00206                 <font class="keywordflow">case</font> -1:
00207                         <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Error in system(&lt;"</font> &lt;&lt; program &lt;&lt; <font class="stringliteral">"&gt;) call in Target_Access::syscommand()\n"</font>;
00208                         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00209                 <font class="keywordflow">case</font> 127:
00210                         <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Execve() call for /bin/sh failed in Target_Access::syscommand()\n"</font>;
00211                         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00212                 <font class="keywordflow">default</font>:
00213                         <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Return value of "</font> &lt;&lt; program &lt;&lt; <font class="stringliteral">" was "</font> &lt;&lt; sysret &lt;&lt; <font class="stringliteral">" in Target_Access::syscommand()\n"</font>;
00214                         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00215         }
00216 }
00217 
<a name="l00218"></a><a class="code" href="classTarget__Access.html#a7">00218</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a7">Target_Access::uncompress</a>() {
00219         <font class="comment">// makes sure an uncompressed version is available</font>
00220         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n6">uncompressed</a>.<a class="code" href="classString.html#a106">empty</a>()) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00221         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#a6">make_local_copy</a>()) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00222         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> gzrx(<font class="stringliteral">"[.][Gg]?[Zz]$"</font>);
00223         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n5">localcopy</a>.<a class="code" href="classString.html#a32">contains</a>(gzrx)) {
00224                 <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(<a class="code" href="classTarget__Access.html#n6">uncompressed</a>,<a class="code" href="classTarget__Access.html#n5">localcopy</a>,gzrx);
00225 <font class="comment">//cerr &lt;&lt; "Uncompressed: " &lt;&lt; uncompressed &lt;&lt; '\n';</font>
00226                 remove(<a class="code" href="classTarget__Access.html#n6">uncompressed</a>); <font class="comment">// remove possible stale file</font>
00227                 <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#b8">syscommand</a>(<font class="stringliteral">"gzip"</font>,<font class="stringliteral">"-d -c "</font>+<a class="code" href="classTarget__Access.html#n5">localcopy</a>+<font class="stringliteral">" &gt; "</font>+<a class="code" href="classTarget__Access.html#n6">uncompressed</a>)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00228         } <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n6">uncompressed</a> = <a class="code" href="classTarget__Access.html#n5">localcopy</a>;
00229         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00230 }
00231 
<a name="l00232"></a><a class="code" href="classTarget__Access.html#a8">00232</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a8">Target_Access::cleartext_conversion</a>() {
00233         <font class="comment">// makes sure a clear text version is available</font>
00234         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n7">cleartext</a>.<a class="code" href="classString.html#a106">empty</a>()) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00235         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#a7">uncompress</a>()) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00236         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> psrx(<font class="stringliteral">"[.][Pp][Ss]$"</font>); <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> pdfrx(<font class="stringliteral">"[.][Pp][Dd][Ff]$"</font>);
00237         <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n6">uncompressed</a>.<a class="code" href="classString.html#a32">contains</a>(psrx)) {
00238                 <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(<a class="code" href="classTarget__Access.html#n7">cleartext</a>,<a class="code" href="classTarget__Access.html#n6">uncompressed</a>,psrx);
00239                 remove(<a class="code" href="classTarget__Access.html#n7">cleartext</a>); <font class="comment">// remove possible stale file</font>
00240                 <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#b8">syscommand</a>(<font class="stringliteral">"pstotext"</font>,<a class="code" href="classTarget__Access.html#n6">uncompressed</a>+<font class="stringliteral">" &gt; "</font>+<a class="code" href="classTarget__Access.html#n7">cleartext</a>)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00241         } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classTarget__Access.html#n6">uncompressed</a>.<a class="code" href="classString.html#a32">contains</a>(pdfrx)) {
00242                 <a class="code" href="classTarget__Access.html#b3">transformed_name</a>(<a class="code" href="classTarget__Access.html#n7">cleartext</a>,<a class="code" href="classTarget__Access.html#n6">uncompressed</a>,pdfrx);
00243                 remove(<a class="code" href="classTarget__Access.html#n7">cleartext</a>); <font class="comment">// remove possible stale file</font>
00244                 <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#b8">syscommand</a>(<font class="stringliteral">"pdftotext"</font>,<font class="stringliteral">"-raw "</font>+<a class="code" href="classTarget__Access.html#n6">uncompressed</a>+<font class="charliteral">' '</font>+<a class="code" href="classTarget__Access.html#n7">cleartext</a>)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00245         } <font class="keywordflow">else</font> <a class="code" href="classTarget__Access.html#n7">cleartext</a> = <a class="code" href="classTarget__Access.html#n6">uncompressed</a>;
00246 <font class="comment">//cerr &lt;&lt; "Cleartext: " &lt;&lt; cleartext &lt;&lt; '\n';</font>
00247         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00248 }
00249 
<a name="l00250"></a><a class="code" href="classTarget__Access.html#a9">00250</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a9">Target_Access::read_raw_into_String</a>(<a class="code" href="classString.html">String</a> &amp; text, <font class="keywordtype">bool</font> warnopen = <font class="keyword">true</font>) {
00251         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#a6">make_local_copy</a>()) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00252         <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="classTarget__Access.html#n5">localcopy</a>,text,warnopen)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00253         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n8">retaintransformed</a>) <a class="code" href="classTarget__Access.html#a12">remove_local_copy</a>();
00254         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00255 }
00256 
<a name="l00257"></a><a class="code" href="classTarget__Access.html#a10">00257</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a10">Target_Access::read_uncompressed_into_String</a>(<a class="code" href="classString.html">String</a> &amp; text, <font class="keywordtype">bool</font> warnopen = <font class="keyword">true</font>) {
00258         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#a7">uncompress</a>()) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00259         <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="classTarget__Access.html#n6">uncompressed</a>,text,warnopen)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00260         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n8">retaintransformed</a>) {
00261                 <a class="code" href="classTarget__Access.html#a13">remove_uncompressed</a>();
00262                 <a class="code" href="classTarget__Access.html#a12">remove_local_copy</a>();
00263         }
00264         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00265 }
00266 
<a name="l00267"></a><a class="code" href="classTarget__Access.html#a11">00267</a> <font class="keywordtype">bool</font> <a class="code" href="classTarget__Access.html#a11">Target_Access::read_cleartext_into_String</a>(<a class="code" href="classString.html">String</a> &amp; text, <font class="keywordtype">bool</font> warnopen = <font class="keyword">true</font>) {
00268         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#a8">cleartext_conversion</a>()) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00269         <font class="keywordflow">if</font> (!<a class="code" href="utilities_8cc.html#a39">read_file_into_String</a>(<a class="code" href="classTarget__Access.html#n7">cleartext</a>,text,warnopen)) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00270         <font class="keywordflow">if</font> (!<a class="code" href="classTarget__Access.html#n8">retaintransformed</a>) {
00271                 <a class="code" href="classTarget__Access.html#a14">remove_cleartext</a>();
00272                 <a class="code" href="classTarget__Access.html#a13">remove_uncompressed</a>();
00273                 <a class="code" href="classTarget__Access.html#a12">remove_local_copy</a>();
00274         }
00275         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00276 }
00277 
<a name="l00278"></a><a class="code" href="classSearch__Target.html#b0">00278</a> <font class="keywordtype">void</font> <a class="code" href="classSearch__Target.html#b0">Search_Target::check_encountered</a>() {
00279         <font class="keywordflow">if</font> (encountered) {
00280                 <font class="keywordflow">if</font> (<a class="code" href="classSearch__Target.html#n5">encountered</a>-&gt;<a class="code" href="classQuick__String__Hash.html#a4">read</a>((<font class="keyword">const</font> <font class="keywordtype">char</font> *) <a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>())) <a class="code" href="classSearch__Target.html#n6">searched</a> = 1;
00281                 <font class="keywordflow">else</font> (*encountered) &lt;&lt; (<font class="keyword">const</font> <font class="keywordtype">char</font> *) <a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>();
00282         }
00283         <font class="keywordflow">if</font> ((!remotesearch) &amp;&amp; ((<a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a16">Type</a>()==<a class="code" href="classTarget__Access.html#s5s2">Target_Access::TA_HTTP</a>) || (<a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a16">Type</a>()==<a class="code" href="classTarget__Access.html#s5s3">Target_Access::TA_FTP</a>))) <a class="code" href="classSearch__Target.html#n6">searched</a> = -1;
00284 }
00285 
00286 <font class="comment">//#define SEARCH_TARGET_DEBUG</font>
<a name="l00287"></a><a class="code" href="classSearch__Target.html#a3">00287</a> <font class="keywordtype">long</font> <a class="code" href="classSearch__Target.html#a3">Search_Target::search</a>() {
00288         <font class="comment">// Searches the target file for occurrences of searchkey and stores the results</font>
00289 <font class="preprocessor">#ifdef SEARCH_TARGET_DEBUG</font>
00290 <font class="preprocessor"></font>        <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Search_Target::search(), followlinks="</font> &lt;&lt; <a class="code" href="classSearch__Target.html#n3">followlinks</a> &lt;&lt; <font class="stringliteral">", target.Target() = "</font> &lt;&lt; <a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>() &lt;&lt; <font class="charliteral">'\n'</font>;
00291 <font class="preprocessor">#endif</font>
00292 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (<a class="code" href="classSearch__Target.html#n6">searched</a>!=0) {
00293                 <font class="keywordflow">if</font> (verbose) {
00294                         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Target.html#n6">searched</a>==1) <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>() &lt;&lt; <font class="stringliteral">" already searched elsewhere\n"</font>;
00295                         <font class="keywordflow">else</font> <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>() &lt;&lt; <font class="stringliteral">" restricted, do not search\n"</font>;
00296                 }
00297                 <font class="keywordflow">return</font> 0;
00298         }
00299         <a class="code" href="classString.html">String</a> t;
00300         <font class="keywordflow">if</font> (!<a class="code" href="classSearch__Target.html#n2">target</a>.<a class="code" href="classTarget__Access.html#a11">read_cleartext_into_String</a>(t)) <font class="keywordflow">return</font> -1;
00301         <font class="keywordtype">int</font> i = 0, <a class="code" href="templates_8defines_8hh.html#a11">res</a> = 0; <a class="code" href="classBigRegex.html">BigRegex</a> skrx(<a class="code" href="classSearch__Target.html#n1">searchkey</a>);
00302         <font class="keywordflow">while</font> ((i=t.<a class="code" href="classString.html#a26">index</a>(skrx,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,i))&gt;=0) {
00303                 <a class="code" href="classSearch__Result.html">Search_Result</a> * r = <font class="keyword">new</font> <a class="code" href="classSearch__Result.html">Search_Result</a>(<a class="code" href="classSearch__Target.html#n1">searchkey</a>,<a class="code" href="classSearch__Target.html#n2">target</a>,t,skrx);
00304                 <font class="keywordflow">if</font> (((r-&gt;<a class="code" href="classSearch__Result.html#a1">Type</a>()==<a class="code" href="classSearch__Result.html#s3s1">Search_Result::SR_DIRECTORY_ENTRY</a>) || (r-&gt;<a class="code" href="classSearch__Result.html#a1">Type</a>()==<a class="code" href="classSearch__Result.html#s3s2">Search_Result::SR_URL</a>)) &amp;&amp; (<a class="code" href="classSearch__Target.html#n0">results</a>-&gt;<a class="code" href="classPLLRoot.html#a3">tail</a>())) <font class="keywordflow">if</font> (*(<a class="code" href="classSearch__Target.html#n0">results</a>-&gt;<a class="code" href="classPLLRoot.html#a3">tail</a>())==*r) {
00305                         <font class="keyword">delete</font> r; <font class="comment">// try to avoid duplicates</font>
00306                         <font class="keywordflow">continue</font>;
00307                 }
00308                 <a class="code" href="classSearch__Target.html#n0">results</a>-&gt;<a class="code" href="classPLLRoot.html#a8">link_before</a>(r);
00309                 <a class="code" href="templates_8defines_8hh.html#a11">res</a>++;
00310         }
00311         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Target.html#n3">followlinks</a>&gt;0) <a class="code" href="classSearch__Target.html#a4">links</a>(t); <font class="comment">// if followlinks&gt;0 then links are sought and added to the search</font>
00312         <a class="code" href="classSearch__Target.html#n6">searched</a> = 1;
00313         <font class="keywordflow">return</font> <a class="code" href="templates_8defines_8hh.html#a11">res</a>;
00314 }
00315 
<a name="l00316"></a><a class="code" href="classSearch__Target.html#a4">00316</a> <font class="keywordtype">long</font> <a class="code" href="classSearch__Target.html#a4">Search_Target::links</a>(<font class="keyword">const</font> <a class="code" href="classString.html">String</a> &amp; t) {
00317         <font class="comment">// Finds links in the text t and adds them to the list of targets</font>
00318         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> linksrx(<font class="stringliteral">"[&lt;][Aa][^&gt;]+[Hh][Rr][Ee][Ff]"</font>);
00319         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> lkendrx(<font class="stringliteral">"[&lt;][/][Aa][ \t]?[^&gt;]*[&gt;]"</font>);
00320         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> urlstartrx(<font class="stringliteral">"=[ \t]*\"?"</font>);
00321         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> mailtorx(<font class="stringliteral">"^[ \t]*[Mm][Aa][Ii][Ll][Tt][Oo][ \t]*:"</font>);
00322         <font class="keywordtype">int</font> i = 0;
00323         <font class="keywordflow">while</font> ((i=t.<a class="code" href="classString.html#a26">index</a>(linksrx,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,i))&gt;=0) {
00324                 <font class="keywordtype">int</font> urlstart = t.<a class="code" href="classString.html#a26">index</a>(urlstartrx,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,i); <font class="comment">// find URL start</font>
00325                 <font class="keywordflow">if</font> (urlstart&gt;=0) {
00326                         <font class="keywordtype">int</font> urlend;
00327                         <font class="keywordflow">if</font> (t[urlstart-1]==<font class="charliteral">'"'</font>) urlend = t.<a class="code" href="classString.html#a26">index</a>(<font class="charliteral">'"'</font>,urlstart); <font class="comment">// find matching '"'</font>
00328                         <font class="keywordflow">else</font> urlend = t.<a class="code" href="classString.html#a26">index</a>(BRXwhite,urlstart); <font class="comment">// find white-space terminated URL</font>
00329                         <font class="keywordflow">if</font> (urlend&gt;=0) {
00330                                 <a class="code" href="classString.html">String</a> url(const_cast&lt;String &amp;&gt;(t).at(urlstart,urlend-urlstart)); <font class="comment">// get URL</font>
00331                                 <a class="code" href="search_8cc.html#a0">generic_remove_name_reference</a>(url);
00332                                 <font class="keywordflow">if</font> (!(url.<a class="code" href="classString.html#a106">empty</a>() || url.<a class="code" href="classString.html#a32">contains</a>(mailtorx))) {
00333                                         <font class="comment">// *** currently assumes breadth-first search</font>
00334                                         <a class="code" href="classSearch__Target.html">Search_Target</a> * st = <font class="keyword">new</font> <a class="code" href="classSearch__Target.html#a0">Search_Target</a>(*<font class="keyword">this</font>,url);
00335                                         <a class="code" href="classPLLHandle.html#a0">Root</a>()-&gt;<a class="code" href="classPLLRoot.html#a8">link_before</a>(st); <font class="comment">// append st to list</font>
00336                                 }
00337                         }
00338                 }
00339                 i = t.<a class="code" href="classString.html#a26">index</a>(lkendrx,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,i); <font class="comment">// find end of hyperlink</font>
00340         }       
00341 }
00342 
<a name="l00343"></a><a class="code" href="classSearch__Result.html#a0">00343</a> <a class="code" href="classSearch__Result.html#a0">Search_Result::Search_Result</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> * s, <font class="keyword">const</font> <a class="code" href="classTarget__Access.html">Target_Access</a> &amp; t, <a class="code" href="classString.html">String</a> &amp; text, <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> &amp; skrx): searchkey(s), target(t), location(skrx.subpos()) {
00344         <font class="comment">// Obtains the matched keytext and some pretext and posttext</font>
00345         <font class="keyword">const</font> <font class="keywordtype">int</font> PTEXTSIZE = 160;
00346         <a class="code" href="classSearch__Result.html#n3">keytext</a> = text.<a class="code" href="classString.html#a82">sub</a>(skrx,0);
00347         <font class="keywordflow">if</font> (t.<a class="code" href="classTarget__Access.html#a16">Type</a>()!=<a class="code" href="classTarget__Access.html#s5s1">Target_Access::TA_LOCAL_DIRECTORY</a>) { <font class="comment">// get pretext and posttext</font>
00348                 <font class="comment">// *** DETECT HERE IF SR_URL!</font>
00349                 <a class="code" href="classSearch__Result.html#n6">type</a> = <a class="code" href="classSearch__Result.html#s3s0">SR_REGULAR</a>;
00350                 <font class="keywordflow">if</font> (skrx.subpos()&gt;PTEXTSIZE) <a class="code" href="classSearch__Result.html#n2">pretext</a> = text.<a class="code" href="classString.html#a51">at</a>(skrx.subpos()-PTEXTSIZE,PTEXTSIZE); <font class="keywordflow">else</font> <a class="code" href="classSearch__Result.html#n2">pretext</a> = text.<a class="code" href="classString.html#a58">before</a>(skrx.subpos());
00351                 <font class="keywordtype">int</font> skrxend = skrx.subpos()+skrx.sublen();
00352                 <font class="keywordflow">if</font> ((skrxend+PTEXTSIZE)&lt;text.<a class="code" href="classString.html#a105">length</a>()) <a class="code" href="classSearch__Result.html#n4">posttext</a> = text.<a class="code" href="classString.html#a51">at</a>(skrxend,PTEXTSIZE); <font class="keywordflow">else</font> <a class="code" href="classSearch__Result.html#n4">posttext</a> = text.<a class="code" href="classString.html#a70">from</a>(skrxend);
00353         } <font class="keywordflow">else</font> { <font class="comment">// get complete directory entry reference</font>
00354                 <a class="code" href="classSearch__Result.html#n6">type</a> = <a class="code" href="classSearch__Result.html#s3s1">SR_DIRECTORY_ENTRY</a>;
00355                 <font class="keywordtype">int</font> entrystart = text.<a class="code" href="classString.html#a26">index</a>(<font class="stringliteral">"&lt;A HREF="</font>,(<font class="keywordtype">int</font>) (skrx.subpos()-text.<a class="code" href="classString.html#a105">length</a>()));
00356                 <font class="keywordflow">if</font> (entrystart&gt;=0) {
00357                         <font class="keywordtype">int</font> entryend = text.<a class="code" href="classString.html#a26">index</a>(<font class="stringliteral">"&lt;/A&gt;"</font>,skrx.subpos());
00358                         <font class="keywordflow">if</font> (entryend&gt;=0) {
00359                                 <font class="keywordtype">int</font> urlend = text.<a class="code" href="classString.html#a26">index</a>(<font class="stringliteral">"\"&gt;"</font>,<a class="code" href="classString.html#s2s1">String::SEARCH_END</a>,entrystart);
00360                                 <font class="keywordflow">if</font> (urlend&gt;=0) {
00361                                         <a class="code" href="classSearch__Result.html#n2">pretext</a> = text.<a class="code" href="classString.html#a51">at</a>(entrystart,urlend-entrystart); <font class="comment">// get URL</font>
00362                                         <font class="comment">// split reference text into pre, key and post parts</font>
00363                                         <a class="code" href="classSearch__Result.html#n4">posttext</a> = text.<a class="code" href="classString.html#a51">at</a>(urlend,entryend-urlend);
00364                                         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n4">posttext</a>.<a class="code" href="classString.html#a32">contains</a>(skrx)) {
00365                                                 <a class="code" href="classSearch__Result.html#n2">pretext</a> += <a class="code" href="classSearch__Result.html#n4">posttext</a>.<a class="code" href="classString.html#a58">before</a>(skrx.subpos());
00366                                                 <a class="code" href="classSearch__Result.html#n3">keytext</a> = <a class="code" href="classSearch__Result.html#n4">posttext</a>.<a class="code" href="classString.html#a82">sub</a>(skrx,0);
00367                                                 <a class="code" href="classSearch__Result.html#n4">posttext</a> = <a class="code" href="classSearch__Result.html#n4">posttext</a>.<a class="code" href="classString.html#a70">from</a>(skrx.subpos()+skrx.sublen());
00368                                         } <font class="keywordflow">else</font> { <font class="comment">// should never occur in a SR_DIRECTORY_ENTRY, just for extra safety</font>
00369                                                 <a class="code" href="classSearch__Result.html#n2">pretext</a> += <font class="charliteral">'['</font>;
00370                                                 <a class="code" href="classSearch__Result.html#n4">posttext</a>.<a class="code" href="classString.html#a22">prepend</a>(<font class="stringliteral">"] "</font>);
00371                                         }
00372                                         <a class="code" href="classSearch__Result.html#n4">posttext</a> += <font class="stringliteral">"&lt;/A&gt;"</font>;
00373                                 }
00374                         }
00375                 }
00376         }
00377 }
00378 
<a name="l00379"></a><a class="code" href="classSearch__Result.html#a2">00379</a> <font class="keywordtype">int</font> <a class="code" href="classSearch__Result.html#a2">Search_Result::isequal</a>(<font class="keyword">const</font> <a class="code" href="classSearch__Result.html">Search_Result</a> &amp; sr)<font class="keyword"> const </font>{
00380         <font class="comment">// Equality comparison operator</font>
00381         <font class="comment">// Note: This could also have been defined as a function that takes two arguments</font>
00382         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n0">searchkey</a>!=sr.<a class="code" href="classSearch__Result.html#n0">searchkey</a>) <font class="keywordflow">return</font> 0;
00383         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n1">target</a>!=sr.<a class="code" href="classSearch__Result.html#n1">target</a>) <font class="keywordflow">return</font> 0;
00384         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n2">pretext</a>!=sr.<a class="code" href="classSearch__Result.html#n2">pretext</a>) <font class="keywordflow">return</font> 0;
00385         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n3">keytext</a>!=sr.<a class="code" href="classSearch__Result.html#n3">keytext</a>) <font class="keywordflow">return</font> 0;
00386         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n4">posttext</a>!=sr.<a class="code" href="classSearch__Result.html#n4">posttext</a>) <font class="keywordflow">return</font> 0;
00387         <font class="keywordflow">if</font> (<a class="code" href="classSearch__Result.html#n6">type</a>!=sr.<a class="code" href="classSearch__Result.html#n6">type</a>) <font class="keywordflow">return</font> 0;
00388         <font class="keywordflow">return</font> 1;
00389 }
00390 
<a name="l00391"></a><a class="code" href="classSearch__Result.html#a5">00391</a> <a class="code" href="classString.html">String</a> <a class="code" href="classSearch__Result.html#a5">Search_Result::HTML_put_text</a>()<font class="keyword"> const </font>{
00392         <font class="comment">// Produce HTML output for search result</font>
00393         <font class="keyword">static</font> <a class="code" href="classString.html">String</a> <a class="code" href="templates_8defines_8hh.html#a11">res</a>;
00394         <a class="code" href="classString.html">String</a> pre, post, key;
00395         <font class="comment">// *** IMPROVE:</font>
00396         <font class="comment">// - identify any links in the pretext+keytext+posttext and turn them into correct relative links</font>
00397         <font class="comment">// - beware of searchkey found in the middle of an HREF URL</font>
00398         <font class="keywordflow">switch</font> (type) {
00399                 <font class="keywordflow">case</font> <a class="code" href="classSearch__Result.html#s3s0">SR_REGULAR</a>: <font class="comment">// *** this one will be modified with the improvements mentioned above</font>
00400                         pre = <a class="code" href="classSearch__Result.html#n2">pretext</a>; key = <a class="code" href="classSearch__Result.html#n3">keytext</a>; post = <a class="code" href="classSearch__Result.html#n4">posttext</a>;
00401                         res = <font class="stringliteral">"&lt;A HREF=\""</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"\"&gt;"</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"&lt;/A&gt; ["</font>+<a class="code" href="classString.html">String</a>(<a class="code" href="classSearch__Result.html#n5">location</a>)+<font class="stringliteral">"]: "</font>+(*<a class="code" href="utilities_8cc.html#a60">HTML_safe</a>(pre))+<font class="stringliteral">"&lt;FONT COLOR=\"#FF0000\"&gt;&lt;B&gt;"</font>+(*<a class="code" href="utilities_8cc.html#a60">HTML_safe</a>(key))+<font class="stringliteral">"&lt;/B&gt;&lt;/FONT&gt;"</font>+(*<a class="code" href="utilities_8cc.html#a60">HTML_safe</a>(post))+<font class="stringliteral">"\n&lt;P&gt;\n\n"</font>;
00402                         <font class="keywordflow">break</font>;
00403                 <font class="keywordflow">case</font> <a class="code" href="classSearch__Result.html#s3s1">SR_DIRECTORY_ENTRY</a>:
00404                         res = <font class="stringliteral">"&lt;A HREF=\""</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"\"&gt;"</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"&lt;/A&gt;: "</font>+<a class="code" href="classSearch__Result.html#n2">pretext</a>+<font class="stringliteral">"&lt;FONT COLOR=\"#FF0000\"&gt;&lt;B&gt;"</font>+<a class="code" href="classSearch__Result.html#n3">keytext</a>+<font class="stringliteral">"&lt;/B&gt;&lt;/FONT&gt;"</font>+<a class="code" href="classSearch__Result.html#n4">posttext</a>+<font class="stringliteral">"\n&lt;P&gt;\n\n"</font>;
00405                         <font class="keywordflow">break</font>;
00406                 <font class="keywordflow">case</font> <a class="code" href="classSearch__Result.html#s3s2">SR_URL</a>: <font class="comment">// *** implement this correctly!</font>
00407                         res = <font class="stringliteral">"&lt;A HREF=\""</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"\"&gt;"</font>+<a class="code" href="classSearch__Result.html#n1">target</a>.<a class="code" href="classTarget__Access.html#a15">Target</a>()+<font class="stringliteral">"&lt;/A&gt; ["</font>+<a class="code" href="classString.html">String</a>(<a class="code" href="classSearch__Result.html#n5">location</a>)+<font class="stringliteral">"]: "</font>+<a class="code" href="classSearch__Result.html#n2">pretext</a>+<font class="stringliteral">"&lt;FONT COLOR=\"#FF0000\"&gt;&lt;B&gt;"</font>+<a class="code" href="classSearch__Result.html#n3">keytext</a>+<font class="stringliteral">"&lt;/B&gt;&lt;/FONT&gt;"</font>+<a class="code" href="classSearch__Result.html#n4">posttext</a>+<font class="stringliteral">"\n&lt;P&gt;\n\n"</font>;
00408                         <font class="keywordflow">break</font>;
00409         }
00410         <font class="keywordflow">return</font> res;
00411 }
00412 
<a name="l00413"></a><a class="code" href="search_8cc.html#a1">00413</a> <font class="keywordtype">long</font> <a class="code" href="search_8cc.html#a1">search_output</a>(<a class="code" href="classPLLRoot.html">PLLRoot&lt;Search_Result&gt;</a> * sr, <a class="code" href="classString.html">String</a> &amp; <a class="code" href="templates_8defines_8hh.html#a11">res</a>, <font class="keywordtype">bool</font> stringoutput = <font class="keyword">true</font>) {
00414         <font class="comment">// output results</font>
00415         <font class="keywordflow">if</font> (stringoutput) <a class="code" href="templates_8classic_8hh.html#a1">PLL_LOOP_FORWARD</a>(<a class="code" href="classSearch__Result.html">Search_Result</a>,sr-&gt;<a class="code" href="classPLLRoot.html#a2">head</a>(),1) res += e-&gt;HTML_put_text();
00416         <font class="keywordflow">else</font> {
00417                 <a class="code" href="templates_8classic_8hh.html#a1">PLL_LOOP_FORWARD</a>(<a class="code" href="classSearch__Result.html">Search_Result</a>,sr-&gt;<a class="code" href="classPLLRoot.html#a2">head</a>(),1) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; e-&gt;HTML_put_text();
00418                 <a class="code" href="dil2al_8hh.html#a108">VOUT</a>.flush();
00419         }
00420         <font class="keywordtype">long</font> num = sr-&gt;<a class="code" href="classPLLRoot.html#a6">length</a>();
00421         sr-&gt;<a class="code" href="classPLLRoot.html#a16">clear</a>();
00422         <font class="keywordflow">return</font> num;
00423 }
00424 
<a name="l00425"></a><a class="code" href="search_8cc.html#a2">00425</a> <a class="code" href="classString.html">String</a> <a class="code" href="search_8cc.html#a2">search</a>(<a class="code" href="classStringList.html">StringList</a> &amp; targets, <a class="code" href="classString.html">String</a> searchkey, <font class="keywordtype">bool</font> stringoutput = <font class="keyword">true</font>) {
00426         <font class="comment">// Search the target for searchkey</font>
00427         <font class="comment">// Result output is returned as a string or on VOUT.</font>
00428         <font class="comment">// Returns results as string or a string with the number of results.</font>
00429         <font class="comment">// Note: Directories are conceptually handled in the same manner</font>
00430         <font class="comment">// as HTML pages, but they are read differently and can contain</font>
00431         <font class="comment">// only links to follow for recursive searching.</font>
00432         <font class="comment">// Note: It is quite easy to make alternative search functions using</font>
00433         <font class="comment">// the Search_Target and Search_Result classes.</font>
00434         <font class="comment">// initialize global lists</font>
00435         <font class="keyword">static</font> <a class="code" href="classString.html">String</a> <a class="code" href="templates_8defines_8hh.html#a11">res</a>; <font class="comment">// stored in function, not objects, static to avoid problems with lifetime of object that return value points to</font>
00436         <a class="code" href="classPLLRoot.html">PLLRoot&lt;Search_Result&gt;</a> results;
00437         <a class="code" href="classPLLRoot.html">PLLRoot&lt;Search_Target&gt;</a> globaltargets;
00438         <a class="code" href="classQuick__String__Hash.html">Quick_String_Hash</a> encountered;
00439         <font class="comment">// search target objects for searchkey</font>
00440         <font class="comment">// *** Whether the list of Search_Target objects ever becomes</font>
00441         <font class="comment">//     greater than one depends on whether a followlinks search</font>
00442         <font class="comment">//     is conducted in breadth-first or depth-first fashion.</font>
00443         <a class="code" href="classSearch__Target.html">Search_Target</a> * t; <a class="code" href="classString.html">String</a> progressfile(tareadfile+<font class="stringliteral">"progress"</font>), progress; <font class="keywordtype">long</font> resnum = 0;
00444         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i&lt;targets.<a class="code" href="classStringList.html#a10">length</a>(); i++) <font class="keywordflow">if</font> (!targets[i].empty()) {
00445 <font class="comment">//cerr &lt;&lt; searchkey &lt;&lt; " in " &lt;&lt; targets[i] &lt;&lt; '\n'; cerr.flush();</font>
00446                 t = <font class="keyword">new</font> <a class="code" href="classSearch__Target.html">Search_Target</a>(&amp;results,searchkey,targets[i],followlinks,<font class="keyword">false</font>,&amp;encountered);
00447                 globaltargets.<a class="code" href="classPLLRoot.html#a8">link_before</a>(t);
00448                 <font class="comment">// *** Not quite sure where to put the next lines, in this</font>
00449                 <font class="comment">//     loop or outside it, and how that affects the search</font>
00450                 <font class="comment">//     order if additional targets are added by finding</font>
00451                 <font class="comment">//     links to follow in a breadth-first followlinks search.</font>
00452                 <font class="keywordtype">long</font> i_search = 0;
00453                 <a class="code" href="templates_8classic_8hh.html#a1">PLL_LOOP_FORWARD</a>(<a class="code" href="classSearch__Target.html">Search_Target</a>,globaltargets.<a class="code" href="classPLLRoot.html#a2">head</a>(),1) {
00454                         <font class="keywordflow">if</font> (searchprogressmeter) { <font class="comment">// write a progress meter to a file</font>
00455                                 progress = <a class="code" href="classString.html">String</a>((<font class="keywordtype">long</font>) i)+<font class="charliteral">','</font>+<a class="code" href="classString.html">String</a>(i_search)+<font class="charliteral">':'</font>+e-&gt;Target();
00456                                 <a class="code" href="utilities_8cc.html#a41">write_file_from_String</a>(progressfile,progress,<font class="stringliteral">""</font>,<font class="keyword">true</font>);
00457                                 i_search++;
00458                         }
00459                         e-&gt;search();
00460                         <font class="keywordflow">if</font> (immediatesearchoutput) resnum += <a class="code" href="search_8cc.html#a1">search_output</a>(&amp;results,res,stringoutput);
00461                         <font class="comment">// *** caused problems here: e-&gt;remove(); // frees up space and avoids repeated searches</font>
00462                 }
00463                 globaltargets.<a class="code" href="classPLLRoot.html#a16">clear</a>(); <font class="comment">// frees up space and avoids repeated searches</font>
00464         }
00465         <font class="keywordflow">if</font> (!immediatesearchoutput) resnum = <a class="code" href="search_8cc.html#a1">search_output</a>(&amp;results,res,stringoutput);
00466         <font class="keywordflow">if</font> (!stringoutput) res = <a class="code" href="classString.html">String</a>(resnum);
00467         <font class="keywordflow">return</font> res;
00468 }
00469 
<a name="l00470"></a><a class="code" href="search_8cc.html#a3">00470</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="search_8cc.html#a3">Get_Target_Directory</a>(<a class="code" href="classStringList.html">StringList</a> &amp; targets, <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i, <a class="code" href="classString.html">String</a> dirpath) {
00471         <font class="comment">// add filenames from a directory to the list of targets</font>
00472         <font class="comment">// returns the number of targets added</font>
00473         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> num;
00474         <font class="comment">// get directory content</font>
00475         <a class="code" href="classString.html">String</a> t;
00476         <font class="keywordflow">if</font> (dirpath.<a class="code" href="classString.html#a102">lastchar</a>()==<font class="charliteral">'/'</font>) dirpath.<a class="code" href="classString.html#a83">del</a>((<font class="keywordtype">int</font>) (dirpath.<a class="code" href="classString.html#a105">length</a>()-1),1);
00477         <a class="code" href="classDirectory__Access.html">Directory_Access</a> da(dirpath);
00478         num = da.<a class="code" href="classDirectory__Access.html#a1">read</a>(t);
00479         <font class="keywordflow">if</font> (num&lt;0) {
00480                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Unable to read directory "</font> &lt;&lt; dirpath &lt;&lt; <font class="charliteral">'\n'</font>;
00481                 <font class="keywordflow">return</font> 0;
00482         }
00483         t.<a class="code" href="classString.html#a83">del</a>(0,1); <font class="comment">// remove first separator character</font>
00484         <a class="code" href="classStringList.html">StringList</a> df(t,<font class="charliteral">'/'</font>); <a class="code" href="classString.html">String</a> f;
00485         <font class="comment">// add verified files to targets list and adjust num as needed</font>
00486         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> j = 0; j&lt;(df.<a class="code" href="classStringList.html#a10">length</a>()-1); j++) {
00487                 f = dirpath+<font class="charliteral">'/'</font>+df[j];
00488                 <font class="keywordflow">if</font> (<a class="code" href="utilities_8cc.html#a33">file_is_regular_or_symlink</a>(f)) {
00489                         targets[i] = f;
00490                         i++;
00491                 } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (followlinks&gt;0) { <font class="comment">// can enable recursive searching of directories</font>
00492                         <font class="keywordflow">if</font> ((<a class="code" href="utilities_8cc.html#a34">file_is_directory</a>(f)) &amp;&amp; (df[j]!=<font class="stringliteral">"."</font>) &amp;&amp; (df[j]!=<font class="stringliteral">".."</font>)) {
00493                                 targets[i] = f;
00494                                 i++;
00495                         } <font class="keywordflow">else</font> num --;
00496                 } <font class="keywordflow">else</font> num--;
00497         }
00498         <font class="keywordflow">return</font> num;
00499 }
00500 
<a name="l00501"></a><a class="code" href="search_8cc.html#a4">00501</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="search_8cc.html#a4">Get_Target_Regex</a>(<a class="code" href="classStringList.html">StringList</a> &amp; targets, <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i, <a class="code" href="classString.html">String</a> dirpath) {
00502         <font class="comment">// add filenames from a directory to the list of targets that match a regex</font>
00503         <font class="comment">// returns the number of targets added</font>
00504         <font class="comment">// the regex is provided as "@regex-pattern@" following the directory, '@' need not be escaped</font>
00505         <a class="code" href="classStringList.html">StringList</a> d;
00506         <a class="code" href="classBigRegex.html">BigRegex</a> trx(<font class="stringliteral">"@[^/]+@$"</font>);
00507         <font class="comment">// get regex</font>
00508         <font class="keywordflow">if</font> (!dirpath.<a class="code" href="classString.html#a32">contains</a>(trx)) {
00509                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: No regex pattern in "</font> &lt;&lt; dirpath &lt;&lt; <font class="stringliteral">" in Get_Target_Regex()\n"</font>;
00510                 <font class="keywordflow">return</font> 0;
00511         }
00512         <a class="code" href="classString.html">String</a> fileregex = dirpath.<a class="code" href="classString.html#a82">sub</a>(trx,0); fileregex.<a class="code" href="classString.html#a83">del</a>(0,1); fileregex.<a class="code" href="classString.html#a83">del</a>((<font class="keywordtype">int</font>) (fileregex.<a class="code" href="classString.html#a105">length</a>()-1),1);
00513         <font class="comment">// get directory content</font>
00514         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> num = <a class="code" href="search_8cc.html#a3">Get_Target_Directory</a>(d,0,dirpath.<a class="code" href="classString.html#a58">before</a>(trx.<a class="code" href="classBigRegex.html#a5">subpos</a>()));
00515         <font class="comment">// add files that match the regex to targets list and ajust num as needed</font>
00516         <a class="code" href="classString.html">String</a> filename; <a class="code" href="classBigRegex.html">BigRegex</a> frx(fileregex);
00517         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> j = 0; j&lt;d.<a class="code" href="classStringList.html#a10">length</a>(); j++) {
00518                 filename = d[j].from(trx.<a class="code" href="classBigRegex.html#a5">subpos</a>());
00519                 <font class="keywordflow">if</font> (filename.<a class="code" href="classString.html#a42">matches</a>(frx)) {
00520                         targets[i] = d[j];
00521                         i++;
00522                 } <font class="keywordflow">else</font> num--;
00523         }
00524         <font class="keywordflow">return</font> num;
00525 }
00526 
<a name="l00527"></a><a class="code" href="search_8cc.html#a5">00527</a> <font class="keywordtype">bool</font> <a class="code" href="search_8cc.html#a5">search_cmd</a>(<a class="code" href="classString.html">String</a> grepinfo) {
00528         <font class="comment">// Command line interface to search()</font>
00529         <font class="comment">// Note: For optimal use, wrap the output of this call in a complete framework</font>
00530         <font class="comment">// for an HTML file. It is also possible to direct the error output to another</font>
00531         <font class="comment">// file and to link to that one from the HTML file with the search results.</font>
00532         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> trx(<font class="stringliteral">"@[^/]+@$"</font>);
00533         <font class="keyword">const</font> <a class="code" href="classBigRegex.html">BigRegex</a> rrx(<font class="stringliteral">"\\(^[Hh][Tt][Tt][Pp]:\\|^[Ff][Tt][Pp]:\\)"</font>);
00534         <font class="keywordflow">if</font> (grepinfo.<a class="code" href="classString.html#a106">empty</a>()) {
00535                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Missing search information in search_cmd()\n"</font>;
00536                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00537         }
00538         <font class="keywordtype">char</font> separator = grepinfo[0];
00539         grepinfo.<a class="code" href="classString.html#a89">gsub</a>(<a class="code" href="BigString_8cc.html#a39">replicate</a>(separator,2),(<font class="keywordtype">char</font>) 255); <font class="comment">// temporarily replace escaped characters</font>
00540         <font class="keywordtype">int</font> keyend = grepinfo.<a class="code" href="classString.html#a26">index</a>(separator,1);
00541         <font class="keywordflow">if</font> (keyend&lt;0) {
00542                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Missing search key end in search_cmd()\n"</font>;
00543                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00544         }
00545         <font class="keywordflow">if</font> (keyend==1) {
00546                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Zero length search key in search_cmd()\n"</font>;
00547                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00548         }
00549         <font class="keywordflow">if</font> ((keyend+1)&gt;=grepinfo.<a class="code" href="classString.html#a105">length</a>()) {
00550                 <a class="code" href="dil2al_8hh.html#a107">EOUT</a> &lt;&lt; <font class="stringliteral">"dil2al: Missing search target in search_cmd()\n"</font>;
00551                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00552         }
00553         <font class="comment">// put all search targets into a StringList</font>
00554         <a class="code" href="classString.html">String</a> searchkey(grepinfo.<a class="code" href="classString.html#a51">at</a>(1,keyend-1)); searchkey.<a class="code" href="classString.html#a89">gsub</a>((<font class="keywordtype">char</font>) 255,separator); <font class="comment">// restore escaped characters</font>
00555         <a class="code" href="classStringList.html">StringList</a> targets;
00556         grepinfo.<a class="code" href="classString.html#a83">del</a>(0,keyend+1);
00557         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> i = 0; (!grepinfo.<a class="code" href="classString.html#a106">empty</a>()); i++) {
00558                 <font class="comment">// get next target from command line arguments</font>
00559                 targets[i] = grepinfo.<a class="code" href="classString.html#a58">before</a>(separator);
00560                 <font class="keywordflow">if</font> (targets[i].empty()) targets[i] = grepinfo;
00561                 targets[i].gsub((<font class="keywordtype">char</font>) 255,separator); <font class="comment">// restore escaped characters</font>
00562                 <font class="comment">// interpret target</font>
00563                 <font class="comment">// *** add: tar(gz) and zip archives, archive declarator, file containing target lines, default set</font>
00564                 <font class="keywordflow">if</font> (targets[i].<a class="code" href="classStringList.html#a12">contains</a>(trx)) i = <a class="code" href="search_8cc.html#a4">Get_Target_Regex</a>(targets,i,targets[i]) - 1;
00565                 <font class="comment">// *** does not yet properly handle remote files matching regex pattern or remote files pointing to archives</font>
00566                 <font class="comment">// Now handled within search: else if (file_is_directory(targets[i])) i = Get_Target_Directory(targets,i,targets[i]) - 1;</font>
00567                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> ((!targets[i].<a class="code" href="classStringList.html#a12">contains</a>(rrx)) &amp;&amp; (<a class="code" href="utilities_8cc.html#a34">file_is_directory</a>(targets[i])) &amp;&amp; (followlinks&lt;=0)) { <font class="comment">// follow links one deep into the directory</font>
00568                         followlinks = 1;
00569                         <font class="keywordflow">if</font> (verbose) <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"(Setting followlinks=1 to search directory.)\n"</font>;
00570                 }
00571                 grepinfo = grepinfo.<a class="code" href="classString.html#a76">after</a>(separator);
00572         }
00573         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="charliteral">'\n'</font>;
00574         <a class="code" href="classString.html">String</a> <a class="code" href="templates_8defines_8hh.html#a11">res</a> = <a class="code" href="search_8cc.html#a2">search</a>(targets,searchkey,<font class="keyword">false</font>);
00575         <a class="code" href="dil2al_8hh.html#a108">VOUT</a> &lt;&lt; <font class="stringliteral">"(Number of search results: &lt;B&gt;"</font> &lt;&lt; res &lt;&lt; <font class="stringliteral">"&lt;/B&gt;)\n&lt;P&gt;\n"</font>;
00576         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00577 }
00578 
<a name="l00579"></a><a class="code" href="search_8cc.html#a6">00579</a> <font class="keywordtype">bool</font> <a class="code" href="search_8cc.html#a6">search_FORM_cmd</a>(<a class="code" href="classStringList.html">StringList</a> * qlist = NULL) {
00580   <font class="comment">// Perform a dil2al regex search with input from an HTML FORM.</font>
00581   <font class="keyword">const</font> <font class="keywordtype">char</font> escapedseparator[3] = {254,254,0};
00582   <font class="keyword">const</font> <font class="keywordtype">char</font> separator = 254;
00583   <font class="keywordflow">if</font> (!qlist) <font class="keywordflow">return</font> <font class="keyword">false</font>;
00584   <a class="code" href="classString.html">String</a> grepinfo(separator);
00585   <font class="keywordtype">int</font> paridx; <a class="code" href="classString.html">String</a> parstr;
00586   <a class="code" href="dil2al_8hh.html#a5">DIL2AL_CONDITIONAL_ERROR_RETURN</a>((paridx=qlist-&gt;contains(<font class="stringliteral">"regex="</font>))&lt;0,<font class="stringliteral">"No regex parameter found in form data in search_FORM_cmd()\n"</font>);
00587   parstr=<a class="code" href="utilities_8cc.html#a79">URI_unescape</a>((*qlist)[paridx].after(<font class="charliteral">'='</font>));
00588   <a class="code" href="dil2al_8hh.html#a5">DIL2AL_CONDITIONAL_ERROR_RETURN</a>(parstr.<a class="code" href="classString.html#a106">empty</a>(),<font class="stringliteral">"Empty regex parameter in search_FORM_cmd()\n"</font>);
00589   parstr.<a class="code" href="classString.html#a89">gsub</a>(separator,escapedseparator);
00590   grepinfo += parstr + separator;
00591   <a class="code" href="dil2al_8hh.html#a5">DIL2AL_CONDITIONAL_ERROR_RETURN</a>((paridx=qlist-&gt;contains(<font class="stringliteral">"targets="</font>))&lt;0,<font class="stringliteral">"No targets parameter found in form data in search_FORM_cmd()\n"</font>);
00592   parstr=<a class="code" href="utilities_8cc.html#a79">URI_unescape</a>((*qlist)[paridx].after(<font class="charliteral">'='</font>));
00593   <a class="code" href="dil2al_8hh.html#a5">DIL2AL_CONDITIONAL_ERROR_RETURN</a>(parstr.<a class="code" href="classString.html#a106">empty</a>(),<font class="stringliteral">"Empty targets parameter in search_FORM_cmd()\n"</font>);
00594   parstr.<a class="code" href="classString.html#a89">gsub</a>(separator,escapedseparator);
00595   parstr.<a class="code" href="classString.html#a89">gsub</a>(<font class="charliteral">'\r'</font>,<font class="stringliteral">""</font>);
00596   parstr.<a class="code" href="classString.html#a89">gsub</a>(<font class="charliteral">'\n'</font>,separator);
00597   grepinfo += parstr;
00598   <font class="keywordflow">return</font> <a class="code" href="search_8cc.html#a5">search_cmd</a>(grepinfo);
00599 }
</pre></div><hr><address align="right"><small>Generated on Mon Sep 13 14:53:10 2004 for dil2al by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
